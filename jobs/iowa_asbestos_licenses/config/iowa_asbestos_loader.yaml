# Iowa Asbestos Licenses Loader Configuration
# 
# This configuration file defines settings for the Iowa Asbestos Licenses
# rerunnable loader that implements the BaseDataLoader pattern.
#
# Data source: https://data.iowa.gov/Workforce/Active-Iowa-Asbestos-Licenses/c9cg-ivvu

loader:
  name: "Iowa Asbestos Licenses Loader"
  type: "government_database"
  version: "1.0.0"
  description: "Loads Active Iowa Asbestos License holders from data.iowa.gov"

# Source definition - used by BaseDataLoader
source_name: "Iowa Division of Labor - Active Asbestos Licenses"
source_type: "iowa_asbestos_database"

source:
  name: "Iowa Division of Labor - Active Asbestos Licenses"
  type: "iowa_asbestos_database"
  update_frequency: "monthly"  # Licenses expire/renew regularly
  url: "https://data.iowa.gov/Workforce/Active-Iowa-Asbestos-Licenses/c9cg-ivvu"
  api_endpoint: "https://data.iowa.gov/resource/c9cg-ivvu"
  
input:
  # Default to looking for most recent download
  file_path: "${JOB_DIR}/data/Active_Iowa_Asbestos_Licenses_${DATE}.csv"
  # Alternative: Use specific file
  # file_path: "${JOB_DIR}/data/Active_Iowa_Asbestos_Licenses_20251002.csv"
  format: "csv"  # or "json"
  encoding: "utf-8"
  
database:
  host: "${DB_HOST}"
  port: 5432
  database: "graph_db"
  user: "${DB_USER}"
  password: "${DB_PASSWORD}"
  
processing:
  batch_size: 500  # Smaller dataset, can use smaller batches
  checkpoint_interval: 1000  # Checkpoint every 1000 records
  max_retries: 3
  retry_delay: 30  # seconds
  
validation:
  required_fields:
    - full_name
    - license_type
  date_fields:
    - issue_date
    - expire_date
  skip_conditions:
    - missing_name
    - invalid_license_type
    
entity_detection:
  # License types as defined in the dataset
  license_types:
    - Worker
    - Inspector
    - "Contractor/Supervisor"
    - "Management Planner"
    - "Project Designer"
    
field_mappings:
  # Map dataset columns to internal fields
  csv:
    folder_rsn: "FolderRSN"
    registration_number: "Registration Number"
    license_type: "License Type"
    first_name: "First Name"
    last_name: "Last Name"
    county: "County"
    issue_date: "Issue Date"
    expire_date: "Expire Date"
  json:
    folder_rsn: "folderrsn"
    registration_number: "registration_number"
    license_type: "license_type"
    first_name: "first_name"
    last_name: "last_name"
    county: "county"
    issue_date: "issue_date"
    expire_date: "expire_date"
    
attributes:
  # Attributes to add to Person nodes
  person_attributes:
    - asbestos_license_type
    - asbestos_registration_number
    - license_status
    - professional_license
    - license_issue_date
    - license_expire_date
    - iowa_folder_rsn
    
provenance:
  confidence_score: 0.95  # Very high confidence - official government source
  source_reliability: "official"
  data_quality: "high"
  
logging:
  level: "INFO"
  file: "${JOB_DIR}/logs/asbestos_loader_${DATE}.log"
  max_size: "50MB"
  retention: 30  # days
  
monitoring:
  metrics_enabled: true
  health_check_interval: 60  # seconds
  alert_thresholds:
    error_rate: 0.02  # Alert if >2% errors (smaller dataset)
    processing_rate_min: 50  # Alert if <50 records/minute
    stalled_minutes: 10  # Alert if no progress for 10 minutes
    
recovery:
  enable_dead_letter_queue: true
  dlq_table: "failed_asbestos_records"
  retry_failed_records: true
  max_retry_attempts: 3
  
scheduling:
  # Monthly run on the first Monday
  cron: "0 3 1-7 * 1"  # 3 AM on first Monday of month
  timezone: "America/Chicago"
  notification_email: "admin@example.com"
  
data_quality:
  # Expected characteristics of the dataset
  expected_records: 2600  # Approximate count
  expected_license_types: 5
  name_validation:
    min_length: 2
    max_length: 100
    allow_special_chars: true  # Allow hyphens, apostrophes
    
deduplication:
  # Strategy for handling duplicate persons
  match_on:
    - full_name
    - registration_number
  merge_strategy: "keep_latest"  # Use most recent license info
  
# Environment variable substitution
# Use ${VAR_NAME} syntax to reference environment variables
# Required environment variables:
#   DB_HOST - Database hostname or IP
#   DB_USER - Database username
#   DB_PASSWORD - Database password
#   DATE - Current date for log file naming (YYYYMMDD format)
#   JOB_DIR - Path to job directory